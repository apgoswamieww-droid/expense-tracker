<!-- 1. Full Page Loader (Checking Session...) -->
<div *ngIf="isInitializing" class="d-flex justify-content-center align-items-center vh-100 bg-white">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <h5 class="text-muted fw-light">Expense Tracker...</h5>
  </div>
</div>

<!-- 2. Login Page (Show only if NOT initializing AND NO session) -->
<app-auth *ngIf="!isInitializing && !session"></app-auth>

<!-- 3. Main App (Show only if NOT initializing AND session exists) -->
<div class="container mt-5" *ngIf="!isInitializing && session">

  <!-- Navbar / Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 fw-bold text-primary">Expense Tracker <span class="text-dark">ðŸ’°</span></h2>
    <div class="d-flex align-items-center">
      <div class="text-end me-3">
        <small class="d-block text-muted" style="font-size: 0.8rem;">Logged in as</small>
        <span class="fw-bold text-dark">{{ session.email }}</span>
      </div>
      <button class="btn btn-outline-danger btn-sm rounded-pill px-3" (click)="logout()">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </button>
    </div>
  </div>

  <!-- Dashboard Analytics -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 bg-primary text-white h-100">
        <div class="card-body">
          <h6 class="card-title opacity-75">Total Balance</h6>
          <h3 class="fw-bold mb-0">â‚¹{{ totalBalance | number }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 bg-light h-100">
        <div class="card-body">
          <h6 class="card-title text-muted">Monthly Budget</h6>
          <h3 class="fw-bold mb-0 text-dark">â‚¹{{ monthlyBudget | number }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100"
        [ngClass]="savings >= 0 ? 'bg-success text-white' : 'bg-danger text-white'">
        <div class="card-body">
          <h6 class="card-title opacity-75">Savings</h6>
          <h3 class="fw-bold mb-0">â‚¹{{ savings | number }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Expense Form -->
  <div class="card p-4 shadow-sm border-0 mb-4 bg-white">
    <h5 class="mb-3 text-secondary">Add New Expense</h5>
    <div class="row g-2">
      <div class="col-md-4">
        <input type="text" class="form-control" [(ngModel)]="newTitle" placeholder="Item Name (e.g. Pizza)">
      </div>
      <div class="col-md-3">
        <input type="number" class="form-control" [(ngModel)]="newAmount" placeholder="Amount (â‚¹)">
      </div>
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="newCategory">
          <option value="All">All</option>
          <option value="Food">Food</option>
          <option value="Grocery">Grocery</option>
          <option value="Rent">Rent</option>
          <option value="Travel">Travel</option>
          <option value="Bills">Bills</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Shopping">Shopping</option>
          <option value="Medical">Medical</option>
          <option value="Investment">Investment</option>
          <option value="Other">Other</option>
          <option value="Education">Education</option>
        </select>
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100 fw-bold" (click)="onSubmit()" [disabled]="isLoading">
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1"></span>
          {{ isLoading ? 'Saving...' : 'Add' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Filters & Search -->
  <div class="card p-3 shadow-sm border-0 mb-4 bg-light">
    <div class="row g-2 align-items-center">
      <div class="col-md-3">
        <input type="text" class="form-control form-control-sm" [(ngModel)]="searchQuery"
          placeholder="Search by Title...">
      </div>
      <div class="col-md-3">
        <select class="form-select form-select-sm" [(ngModel)]="filterCategory">
          <option value="All">All Categories</option>
          <option value="Food">Food</option>
          <option value="Travel">Travel</option>
          <option value="Rent">Rent</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Shopping">Shopping</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control form-control-sm" [(ngModel)]="startDate" placeholder="Start Date">
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control form-control-sm" [(ngModel)]="endDate" placeholder="End Date">
      </div>
      <div class="col-md-2 text-end">
        <button class="btn btn-outline-secondary btn-sm w-100" (click)="clearFilters()">
          Clear Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && expenses.length === 0" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading your expenses...</p>
  </div>

  <!-- Expenses List -->
  <div *ngIf="!isLoading">
    <div class="table-responsive rounded shadow-sm" *ngIf="filteredExpenses.length > 0; else emptyState">
      <table class="table table-hover align-middle mb-0 bg-white">
        <thead class="bg-light">
          <tr>
            <th class="py-3 ps-4">Item</th>
            <th class="py-3">Category</th>
            <th class="py-3">Amount</th>
            <th class="py-3">Date</th>
            <th class="py-3 text-end pe-4">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let exp of filteredExpenses">
            <td class="ps-4 fw-medium">{{ exp.title }}</td>
            <td>
              <span class="badge rounded-pill px-3 py-2" [ngClass]="{
                'bg-warning text-dark': exp.category === 'Food',
                'bg-success': exp.category === 'Groceries' || exp.category === 'Shopping',
                'bg-info text-dark': exp.category === 'Travel' || exp.category === 'Fuel',
                'bg-danger': exp.category === 'Rent' || exp.category === 'Bills',
                'bg-primary': exp.category === 'Entertainment' || exp.category === 'Medical',
                'bg-dark': exp.category === 'Investment',
                'bg-secondary': exp.category === 'Other',
                'bg-light text-dark border': exp.category === 'Education'
              }">
                {{ exp.category }}
              </span>
            </td>
            <td class="fw-bold text-dark">â‚¹{{ exp.amount | number }}</td>
            <td class="text-muted small">{{ exp.created_at | date:'dd MMM yyyy' }}</td>
            <td class="text-end pe-4">
              <button class="btn btn-outline-danger btn-sm border-0" (click)="removeExpense(exp.id)" title="Delete">
                <i class="bi bi-trash-fill"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <ng-template #emptyState>
      <div class="text-center py-5 bg-white rounded shadow-sm">
        <div class="mb-3 display-1 text-muted opacity-25">ðŸ“‚</div>
        <h5 class="text-secondary">No expenses found</h5>
        <p class="text-muted small">Try adjusting your filters or add a new expense.</p>
      </div>
    </ng-template>
  </div>

</div>