<!-- 1. Full Page Loader (Checking Session...) -->
<div *ngIf="isInitializing" class="d-flex justify-content-center align-items-center vh-100 bg-white">
  <div class="text-center">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <h5 class="text-muted fw-light">Expense Tracker...</h5>
  </div>
</div>

<!-- 2. Login Page (Show only if NOT initializing AND NO session) -->
<app-auth *ngIf="!isInitializing && !session"></app-auth>

<!-- 3. Main App (Show only if NOT initializing AND session exists) -->
<div class="container mt-5" *ngIf="!isInitializing && session">

  <!-- Navbar / Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 fw-bold text-primary">Expense Tracker <span class="text-dark">ðŸ’°</span></h2>
    <div class="d-flex align-items-center">
      <div class="text-end me-3">
        <small class="d-block text-muted" style="font-size: 0.8rem;">Logged in as</small>
        <span class="fw-bold text-dark">{{ session.email }}</span>
      </div>
      <button class="btn btn-outline-danger btn-sm rounded-pill px-3" (click)="logout()">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </button>
    </div>
  </div>

  <!-- Dashboard Analytics -->
  <app-dashboard
    [totalBalance]="totalBalance"
    [monthlyBudget]="monthlyBudget"
    [savings]="savings">
  </app-dashboard>

  <!-- Add Expense Form -->
  <app-expense-form
    (expenseAdded)="onExpenseAdded()">
  </app-expense-form>

  <!-- Loading State (Global loading when fetching expenses initially or generally) -->
  <div *ngIf="isLoading && expenses.length === 0" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading your expenses...</p>
  </div>

  <!-- Expenses List -->
  <app-expense-list
    *ngIf="!isLoading"
    [expenses]="expenses"
    (removeExpense)="onRemoveExpense($event)">
  </app-expense-list>

</div>